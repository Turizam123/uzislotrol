<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>üé∞ SPIN –†–æ–ª–µ—Ç–∫–∞ —Å JOKER + –ë–æ–Ω—É—Å + –ú–æ—è—Ç –ø–æ—Ä—Ç—Ñ–µ–π–ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="icon" href="icon-192.png">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #444, #111 55%);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .game-wrapper { max-width: 520px; width: 100%; padding: 20px; }
    .card {
      background: rgba(0,0,0,0.85);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
      border: 1px solid rgba(255,255,255,0.06);
      position: relative;
      overflow: hidden;
    }
    h1 { text-align:center; margin:0 0 4px; }

    .subtitle {
      text-align:center;
      font-size:0.9rem;
      opacity:0.9;
      margin-bottom:6px;
    }
    .subtitle small { font-size:0.8rem; opacity:0.8; display:block; }

    .highlight { color:#ffd86b; }

    .auth-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin:8px 0 4px;
      font-size:0.85rem;
    }
    #authInfo {
      flex:1;
      opacity:0.9;
    }

    #balancesInfo {
      font-size:0.8rem;
      opacity:0.85;
      margin-bottom:4px;
    }

    #walletInfo {
      font-size:0.8rem;
      opacity:0.9;
      margin-bottom:8px;
      padding:6px 8px;
      border-radius:10px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
    }
    #walletInfo strong { color:#ffd86b; }

    .wallet-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-top:4px;
      flex-wrap:wrap;
    }
    .wallet-btn {
      padding:4px 8px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#2ecc71,#27ae60);
      color:#fff;
      font-size:0.78rem;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.7);
      white-space:nowrap;
    }
    .wallet-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    .mode-switch {
      display:flex;
      gap:8px;
      margin-bottom:6px;
    }
    .mode-btn {
      flex:1;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.04);
      color:#fff;
      font-size:0.85rem;
      cursor:pointer;
    }
    .mode-btn.active {
      background:linear-gradient(135deg,#ffd86b,#f4ba00);
      color:#351f00;
      border-color:rgba(0,0,0,0.8);
      font-weight:bold;
    }
    .mode-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    .status-bar {
      display:flex;
      justify-content:space-between;
      margin:6px 0 8px;
      font-size:0.92rem;
    }

    .slot-frame { margin-top:8px; }
    .slot-window {
      padding:10px;
      background:#222;
      border-radius:14px;
      box-shadow:inset 0 0 12px #000;
      position:relative;
    }
    .slot-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      grid-template-rows:repeat(3,80px);
      gap:8px;
    }
    .cell {
      background:#111;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:2.4rem;
      box-shadow:inset 0 0 8px #000;
      transition:transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }
    .middle-row {
      box-shadow:0 0 0 1px rgba(255,215,0,0.7), 0 0 12px rgba(255,215,0,0.4);
    }
    .win {
      background: radial-gradient(circle at 30% 20%, #fff4c2, #e0a900 55%);
      color:#000;
      box-shadow:0 0 0 2px rgba(0,0,0,0.7),0 0 20px rgba(255,230,150,0.8);
    }
    .seven-win {
      animation:seven 0.3s infinite alternate;
      box-shadow:0 0 20px red, 0 0 30px gold;
    }
    .joker-win {
      animation:jokerPulse 0.35s infinite alternate;
      box-shadow:0 0 20px rgba(155,89,182,0.9), 0 0 30px rgba(52,152,219,0.9);
    }
    @keyframes seven {
      from { transform:scale(1); }
      to   { transform:scale(1.12); }
    }
    @keyframes jokerPulse {
      from { transform:scale(1); }
      to   { transform:scale(1.1) rotate(1deg); }
    }
    @keyframes reel-spin {
      0% { transform:translateY(0); }
      50% { transform:translateY(4px); }
      100% { transform:translateY(0); }
    }
    .spinning .cell { animation:reel-spin 0.18s infinite; }

    .controls {
      display:flex;
      justify-content:space-between;
      margin-top:12px;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .spin-btn {
      flex:1;
      padding:12px;
      background:radial-gradient(circle at 20% 20%, #ffec9b,#f4ba00 55%,#a86800);
      border:none;
      border-radius:999px;
      font-size:1.1rem;
      font-weight:bold;
      color:#351f00;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,0.8);
      user-select:none;
      -webkit-user-select:none;
    }
    .spin-btn:active {
      transform:translateY(1px) scale(0.99);
      box-shadow:0 4px 16px rgba(0,0,0,0.9);
    }
    .spin-btn:disabled { opacity:0.6; cursor:not-allowed; }

    .bet-box { display:flex; gap:8px; align-items:center; }
    .icon-btn {
      width:30px; height:30px;
      border-radius:999px;
      border:none;
      background:rgba(255,255,255,0.08);
      color:#fff;
      cursor:pointer;
      font-size:1.1rem;
    }
    #resultText {
      text-align:center;
      margin-top:10px;
      min-height:22px;
      font-size:0.95rem;
    }

    #history {
      margin-top: 10px;
      text-align: center;
      min-height: 30px;
    }
    .history-box {
      display: inline-block;
      position: relative;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid transparent;
      font-size: 0.85rem;
      max-width: 100%;
      white-space: normal;
    }
    .history-box::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid transparent;
    }
    .history-win {
      border-color: rgba(46, 204, 113, 0.9);
      color: #c9ffd8;
      box-shadow: 0 0 10px rgba(46, 204, 113, 0.7), 0 0 20px rgba(39, 174, 96, 0.9);
      animation: historyPulseGreen 0.5s ease-in-out 0s 4 alternate;
    }
    .history-win::after {
      border-top-color: rgba(46, 204, 113, 0.9);
    }
    .history-lose {
      border-color: rgba(231, 76, 60, 0.9);
      color: #ffd1d1;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.7), 0 0 20px rgba(192, 57, 43, 0.9);
      animation: historyPulseRed 0.5s ease-in-out 0s 3 alternate;
    }
    .history-lose::after {
      border-top-color: rgba(231, 76, 60, 0.9);
    }
    .history-joker {
      border-color: rgba(155, 89, 182, 0.95);
      color: #f8e9ff;
      box-shadow: 0 0 10px rgba(155,89,182,0.8), 0 0 24px rgba(52,152,219,0.9);
      animation: historyPulseJoker 0.55s ease-in-out 0s 5 alternate;
    }
    .history-joker::after {
      border-top-color: rgba(155, 89, 182, 0.95);
    }
    @keyframes historyPulseGreen {
      from { transform: translateY(0) scale(1); }
      to   { transform: translateY(-2px) scale(1.05); }
    }
    @keyframes historyPulseRed {
      from { transform: translateY(0) scale(1); }
      to   { transform: translateY(-2px) scale(1.05); }
    }
    @keyframes historyPulseJoker {
      from { transform: translateY(0) scale(1) rotate(-1deg); }
      to   { transform: translateY(-2px) scale(1.06) rotate(1deg); }
    }

    /* –ë–æ–Ω—É—Å overlay */
    .bonus-overlay {
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10;
      backdrop-filter:blur(3px);
    }
    .bonus-hidden { display:none; }
    .bonus-card {
      background: radial-gradient(circle at 20% 0%, #ffec9b, #f39c12 55%, #8e44ad);
      padding:16px;
      border-radius:18px;
      text-align:center;
      box-shadow:0 14px 30px rgba(0,0,0,0.9);
      max-width:360px;
      width:100%;
      animation:bonusIn 0.3s ease-out;
    }
    @keyframes bonusIn {
      from { transform:scale(0.8); opacity:0; }
      to { transform:scale(1); opacity:1; }
    }
    .bonus-title {
      font-size:1.1rem;
      font-weight:bold;
      margin-bottom:4px;
    }
    .bonus-sub {
      font-size:0.85rem;
      margin-bottom:10px;
    }
    .bonus-cards-row {
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }
    .bonus-pick {
      flex:1;
      padding:12px 6px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background:rgba(0,0,0,0.18);
      color:#fff;
      font-size:1.3rem;
      box-shadow:0 6px 14px rgba(0,0,0,0.6);
      transition:transform 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .bonus-pick:hover {
      transform:translateY(-1px) scale(1.03);
      box-shadow:0 10px 18px rgba(0,0,0,0.8);
      background:rgba(0,0,0,0.28);
    }
    .bonus-pick:active {
      transform:translateY(1px) scale(0.98);
      box-shadow:0 4px 10px rgba(0,0,0,0.9);
    }
    .bonus-info {
      font-size:0.8rem;
      margin-top:8px;
      opacity:0.9;
    }

    @media (max-width:480px){
      .slot-grid{ grid-template-rows:repeat(3,68px); }
      .cell{ font-size:2rem; }
      .bonus-card { max-width: 95%; }
    }
  </style>
</head>
<body>

<div class="game-wrapper">
  <div class="card">

    <h1>üé∞ SPIN –†–æ–ª–µ—Ç–∫–∞</h1>
    <p class="subtitle">
      –î–ï–ú–û / –†–ï–ê–õ–ù–ò —Å—Ä–µ–¥—Å—Ç–≤–∞ + BOOSTER + –ë–æ–Ω—É—Å –Ω–∏–≤–æ + –ú–æ—è—Ç –ø–æ—Ä—Ç—Ñ–µ–π–ª.<br>
      <small>–ü–µ—á–µ–ª–∏ —Å–∞–º–æ —Å—Ä–µ–¥–Ω–∏—è—Ç —Ä–µ–¥. üÉè JOKER –Ω–∞ —Ç—Ä–µ—Ç–∏ –±–∞—Ä–∞–±–∞–Ω ‚Üí –±–æ–Ω—É—Å –∏–≥—Ä–∞. –ü–æ—Ä—Ç—Ñ–µ–π–ª—ä—Ç –µ –º–æ–º–µ–Ω—Ç–µ–Ω (—Å–∞–º–æ –∑–∞ —Ç–∞–∑–∏ —Å–µ—Å–∏—è).</small>
    </p>

    <div class="auth-bar">
      <div id="authInfo">–†–µ–∂–∏–º: –î–ï–ú–û (–±–µ–∑ –≤—Ö–æ–¥)</div>
      <div id="googleSignIn"></div>
    </div>

    <div id="balancesInfo">
      –ë–∞–ª–∞–Ω—Å –î–ï–ú–û: <span id="demoBalanceLabel">100</span> |
      –ë–∞–ª–∞–Ω—Å –†–ï–ê–õ–ù–ò: <span id="realBalanceLabel">0</span>
    </div>

    <div id="walletInfo">
      <div><strong>–ú–æ—è—Ç –ø–æ—Ä—Ç—Ñ–µ–π–ª (–º–æ–º–µ–Ω—Ç–µ–Ω, —Å–∞–º–æ –∑–∞ —Ç–µ–∫—É—â–∞—Ç–∞ —Å–µ—Å–∏—è):</strong></div>
      <div>
        –ù–∞—Ç—Ä—É–ø–∞–Ω–∏ –º–æ–Ω–µ—Ç–∏: <span id="walletCoins">0</span> |
        –°—Ç–æ–π–Ω–æ—Å—Ç: <span id="walletBgn">0</span> BGN (~<span id="walletEur">0</span> EUR)
      </div>
      <div class="wallet-row">
        <span style="font-size:0.75rem; opacity:0.8;">
          –í—Å–µ–∫–∏ –±–ª–æ–∫ –æ—Ç 10 000 –º–æ–Ω–µ—Ç–∏ –≤ –†–ï–ê–õ–ï–ù —Ä–µ–∂–∏–º –¥–æ–±–∞–≤—è 10, 20, 30... BGN –ø—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–æ. –î–∞–Ω–Ω–∏—Ç–µ —Å–µ –≥—É–±—è—Ç –ø—Ä–∏ —Ä–µ—Ñ—Ä–µ—à.
        </span>
        <button id="walletCashoutBtn" class="wallet-btn" disabled>
          üí∞ –ó–∞—è–≤–∏ –∏–∑–ø–ª–∞—â–∞–Ω–µ (—Å–∏–º—É–ª–∞—Ü–∏—è)
        </button>
      </div>
    </div>

    <div class="mode-switch">
      <button id="demoModeBtn" class="mode-btn active">–î–ï–ú–û</button>
      <button id="realModeBtn" class="mode-btn" disabled>–†–ï–ê–õ–ù–ò –°–†–ï–î–°–¢–í–ê</button>
    </div>

    <div class="status-bar">
      <div>–ê–∫—Ç–∏–≤–µ–Ω –±–∞–ª–∞–Ω—Å: <span id="balance" class="highlight">100</span> ü™ô</div>
      <div>–†–µ–∂–∏–º: <span id="modeLabel">–î–ï–ú–û</span></div>
    </div>

    <div class="slot-frame">
      <div class="slot-window" id="slotWindow">
        <div class="slot-grid" id="slotGrid">
          <div class="cell" data-row="0" data-col="0">‚ùì</div>
          <div class="cell" data-row="0" data-col="1">‚ùì</div>
          <div class="cell" data-row="0" data-col="2">‚ùì</div>

          <div class="cell middle-row" data-row="1" data-col="0">‚ùì</div>
          <div class="cell middle-row" data-row="1" data-col="1">‚ùì</div>
          <div class="cell middle-row" data-row="1" data-col="2">‚ùì</div>

          <div class="cell" data-row="2" data-col="0">‚ùì</div>
          <div class="cell" data-row="2" data-col="1">‚ùì</div>
          <div class="cell" data-row="2" data-col="2">‚ùì</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="bet-box">
        <button class="icon-btn" id="betMinus">‚àí</button>
        <span id="betValue">5</span>
        <button class="icon-btn" id="betPlus">+</button>
      </div>
      <button id="spinBtn" class="spin-btn">SPIN</button>
    </div>

    <div id="resultText">–ü–µ—á–∞–ª–±–∞ –ø—Ä–∏ 3 –µ–¥–Ω–∞–∫–≤–∏ —Å–∏–º–≤–æ–ª–∞ –ø–æ —Å—Ä–µ–¥–Ω–∏—è —Ä–µ–¥.</div>
    <div id="history"></div>

    <!-- –ë–û–ù–£–° –ù–ò–í–û -->
    <div id="bonusOverlay" class="bonus-overlay bonus-hidden">
      <div class="bonus-card">
        <div class="bonus-title">üéÅ –ë–û–ù–£–° –ò–ì–†–ê</div>
        <div class="bonus-sub">–ò–º–∞—à JOKER –ø–µ—á–∞–ª–±–∞! –ò–∑–±–µ—Ä–∏ –µ–¥–Ω–∞ –æ—Ç —Ç—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏, –∑–∞ –¥–∞ —Å–ø–µ—á–µ–ª–∏—à –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –º–Ω–æ–∂–∏—Ç–µ–ª.</div>
        <div class="bonus-cards-row">
          <button class="bonus-pick" data-mult="2">‚ùì</button>
          <button class="bonus-pick" data-mult="5">‚ùì</button>
          <button class="bonus-pick" data-mult="10">‚ùì</button>
        </div>
        <div class="bonus-info">–ú–Ω–æ–∂–∏—Ç–µ–ª—è—Ç —Å–µ –ø—Ä–∏–ª–∞–≥–∞ –≤—ä—Ä—Ö—É —Ç–µ–∫—É—â–∏—è –∑–∞–ª–æ–≥. –£—Å–ø–µ—Ö! üçÄ</div>
      </div>
    </div>

  </div>
</div>

<!-- –ê—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤–µ -->
<audio id="audioSpin" src="spin_effect.wav" preload="auto"></audio>
<audio id="audioSpinMusic" src="spin_music.wav" preload="auto"></audio>
<audio id="audioWin" src="win.wav" preload="auto"></audio>
<audio id="audioLose" src="lose.wav" preload="auto"></audio>
<audio id="bgMusic" src="music.wav" preload="auto" loop></audio>

<script>
const JOKER_SYMBOL = "üÉè";

const SYMBOLS = [
  {emoji:"7Ô∏è‚É£",weightNormal:1,weightEasy:2},
  {emoji:"üîî",weightNormal:2,weightEasy:3},
  {emoji:"üçí",weightNormal:3,weightEasy:4},
  {emoji:"üçë",weightNormal:4,weightEasy:5},
  {emoji:"üçê",weightNormal:5,weightEasy:6},
  {emoji:"üçá",weightNormal:6,weightEasy:7},
  {emoji:JOKER_SYMBOL,weightNormal:1,weightEasy:2}
];

const PAYOUTS = {
  "7Ô∏è‚É£":100,
  "üîî":40,
  "üçí":25,
  "üçë":15,
  "üçê":10,
  "üçá":5,
  "üÉè":30
};

// –ü–æ—Ä—Ç—Ñ–µ–π–ª ‚Äì –ø—Ä–æ–≥—Ä–µ—Å–∏–≤–µ–Ω, –º–æ–º–µ–Ω—Ç–µ–Ω (–±–µ–∑ –±–∞–∑–∞/–±–µ–∑ localStorage)
const WALLET_STEP = 10000;
const WALLET_BASE_BGN = 10;
const BGN_TO_EUR = 0.51;

// —Ä–µ–∂–∏–º–∏ –∏ –±–∞–ª–∞–Ω—Å–∏ (–±–∞–ª–∞–Ω—Å–∏—Ç–µ –≤—Å–µ –æ—â–µ —Å–µ –ø–∞–∑—è—Ç –ª–æ–∫–∞–ª–Ω–æ –≤ localStorage)
let currentMode = "DEMO";
let demoBalance = 100;
let realBalance = 0;
let currentUser = null;

// –ø–æ—Ä—Ç—Ñ–µ–π–ª (—Å–∞–º–æ –≤ –ø–∞–º–µ—Ç—Ç–∞ –Ω–∞ JS, –≥—É–±–∏ —Å–µ –ø—Ä–∏ —Ä–µ—Ñ—Ä–µ—à)
let walletCoins = 0;
let walletBlocks = 0;
let walletBgn = 0;

// –∏–≥—Ä–∞
let bet=5;
let spinning=false, easyMode=false;
let spinInterval=null, stopRequested=false, autoStopTimeout=null;
let bgMusicStarted=false;

// BOOSTER
let boosterMode = false;
let holdTimeoutId = null;
let isHoldCandidate = false;

// BONUS
let bonusActive = false;
let bonusBaseBet = 0;

// DOM
const balanceEl=document.getElementById("balance");
const demoBalanceLabel=document.getElementById("demoBalanceLabel");
const realBalanceLabel=document.getElementById("realBalanceLabel");
const betValueEl=document.getElementById("betValue");
const spinBtn=document.getElementById("spinBtn");
const betMinusBtn=document.getElementById("betMinus");
const betPlusBtn=document.getElementById("betPlus");
const resultText=document.getElementById("resultText");
const slotWindow=document.getElementById("slotWindow");
const modeLabel=document.getElementById("modeLabel");
const historyEl=document.getElementById("history");
const authInfo=document.getElementById("authInfo");
const demoModeBtn=document.getElementById("demoModeBtn");
const realModeBtn=document.getElementById("realModeBtn");
const bonusOverlay=document.getElementById("bonusOverlay");
const bonusButtons=document.querySelectorAll(".bonus-pick");

const walletCoinsEl=document.getElementById("walletCoins");
const walletBgnEl=document.getElementById("walletBgn");
const walletEurEl=document.getElementById("walletEur");
const walletCashoutBtn=document.getElementById("walletCashoutBtn");

// –∞—É–¥–∏–æ
const audioSpin=document.getElementById("audioSpin");
const audioSpinMusic=document.getElementById("audioSpinMusic");
const audioWin=document.getElementById("audioWin");
const audioLose=document.getElementById("audioLose");
const bgMusic=document.getElementById("bgMusic");

function getDateTime() {
  const d = new Date();
  const pad = n => n.toString().padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ` +
         `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// DEMO –±–∞–ª–∞–Ω—Å (–º–æ–∂–µ—à –¥–∞ –º–∞—Ö–Ω–µ—à localStorage –∏ —Ç—É–∫, –∞–∫–æ –∏—Å–∫–∞—à –≤—Å–∏—á–∫–æ –¥–∞ –µ –º–æ–º–µ–Ω—Ç–Ω–æ)
function loadDemoBalance() {
  const stored = localStorage.getItem("slot_demo_balance");
  demoBalance = stored ? parseInt(stored,10) : 100;
}
function saveDemoBalance() {
  localStorage.setItem("slot_demo_balance", demoBalance);
}

// REAL –±–∞–ª–∞–Ω—Å
function loadRealBalanceForUser(email) {
  const stored = localStorage.getItem("slot_real_balance_"+email);
  realBalance = stored ? parseInt(stored,10) : 1000;
}
function saveRealBalance() {
  if(!currentUser) return;
  localStorage.setItem("slot_real_balance_"+currentUser.email, realBalance);
}

function getBalance() {
  return currentMode==="DEMO" ? demoBalance : realBalance;
}
function setBalance(val) {
  if(currentMode==="DEMO") {
    demoBalance = val;
    saveDemoBalance();
  } else {
    realBalance = val;
    saveRealBalance();
  }
  updateUI();
}

// –º–æ–º–µ–Ω—Ç–µ–Ω –ø–æ—Ä—Ç—Ñ–µ–π–ª ‚Äì –±–µ–∑ –∑–∞–ø–∏—Å
function autoBankToWallet(){
  if(currentMode !== "REAL" || !currentUser) return;
  let bal = getBalance();
  const blocksToBank = Math.floor(bal / WALLET_STEP);
  if(blocksToBank <= 0) return;

  const coinsToBank = blocksToBank * WALLET_STEP;
  bal -= coinsToBank;
  setBalance(bal);

  walletCoins += coinsToBank;

  for(let i=0;i<blocksToBank;i++){
    walletBlocks++;
    walletBgn += WALLET_BASE_BGN * walletBlocks;
  }
  updateUI();
}

function updateWalletUI(){
  walletCoinsEl.textContent = walletCoins;
  walletBgnEl.textContent = walletBgn.toFixed(2);
  walletEurEl.textContent = (walletBgn * BGN_TO_EUR).toFixed(2);
  walletCashoutBtn.disabled = walletBgn <= 0 || !currentUser;
}

function updateUI(){
  balanceEl.textContent = getBalance();
  betValueEl.textContent = bet;
  modeLabel.textContent = currentMode==="DEMO" ? "–î–ï–ú–û" : "–†–ï–ê–õ–ù–ò –°–†–ï–î–°–¢–í–ê";
  demoBalanceLabel.textContent = demoBalance;
  realBalanceLabel.textContent = realBalance;
  updateWalletUI();
}

function play(audio){
  if(!audio) return;
  try { audio.currentTime=0; audio.play(); } catch(e){}
}

function buildPool(includeJoker){
  const pool=[];
  SYMBOLS.forEach(s=>{
    if(!includeJoker && s.emoji===JOKER_SYMBOL) return;
    const w = easyMode ? s.weightEasy : s.weightNormal;
    for(let i=0;i<w;i++) pool.push(s.emoji);
  });
  return pool;
}

function setGrid(matrix){
  document.querySelectorAll(".cell").forEach(c=>{
    let r=c.dataset.row, col=c.dataset.col;
    c.textContent=matrix[r][col];
  });
}

function clearWin(){
  document.querySelectorAll(".cell").forEach(c=>{
    c.classList.remove("win","seven-win","joker-win");
  });
}

function switchMode(mode){
  if(mode==="REAL" && !currentUser){
    resultText.textContent = "–í–ª–µ–∑ —Å Gmail, –∑–∞ –¥–∞ –∏–≥—Ä–∞–µ—à –≤ —Ä–µ–∂–∏–º –†–ï–ê–õ–ù–ò –°–†–ï–î–°–¢–í–ê.";
    return;
  }
  currentMode = mode;
  demoModeBtn.classList.toggle("active", mode==="DEMO");
  realModeBtn.classList.toggle("active", mode==="REAL");
  updateUI();
}

demoModeBtn.onclick = () => switchMode("DEMO");
realModeBtn.onclick = () => switchMode("REAL");

// –ë–û–ù–£–°
function showBonus(baseBet) {
  bonusActive = true;
  bonusBaseBet = baseBet;
  boosterMode = false;
  resultText.textContent = "üéÅ –ë–æ–Ω—É—Å –∏–≥—Ä–∞ ‚Äì –∏–∑–±–µ—Ä–∏ –µ–¥–Ω–∞ –æ—Ç –∫–∞—Ä—Ç–∏—Ç–µ!";
  bonusOverlay.classList.remove("bonus-hidden");
}

function hideBonus() {
  bonusActive = false;
  bonusOverlay.classList.add("bonus-hidden");
}

// —Å–ª–æ—Ç –ª–æ–≥–∏–∫–∞
function startSpin(){
  if(spinning || bonusActive) return;
  if(bet>getBalance()){
    resultText.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–µ–Ω –±–∞–ª–∞–Ω—Å –≤ –∞–∫—Ç–∏–≤–Ω–∏—è —Ä–µ–∂–∏–º.";
    return;
  }

  spinning=true;
  stopRequested=false;
  spinBtn.textContent = boosterMode ? "BOOST..." : "STOP";

  historyEl.innerHTML = "";
  historyEl.className = "";

  clearWin();

  setBalance(getBalance() - bet);

  if(!bgMusicStarted){ play(bgMusic); bgMusicStarted=true; }

  play(audioSpin);
  play(audioSpinMusic);

  const poolAll = buildPool(true);
  const poolNoJoker = buildPool(false);

  let matrix=[["","",""],["","",""],["","",""]];
  slotWindow.classList.add("spinning");

  spinInterval=setInterval(()=>{
    for(let c=0;c<3;c++){
      const pool = (c === 2) ? poolAll : poolNoJoker;
      for(let r=0;r<3;r++){
        matrix[r][c]= pool[Math.floor(Math.random()*pool.length)];
      }
    }
    setGrid(matrix);
    if(stopRequested){
      clearInterval(spinInterval);
      finalize(matrix);
    }
  },90);

  autoStopTimeout=setTimeout(()=>{stopRequested=true;},1600);
}

function stopSpin(){ stopRequested=true; }

function finalize(matrix){
  clearInterval(spinInterval);
  slotWindow.classList.remove("spinning");
  if(autoStopTimeout) clearTimeout(autoStopTimeout);

  try{ audioSpinMusic.pause(); audioSpinMusic.currentTime=0; }catch(e){}

  const mid = 1;
  let a = matrix[mid][0];
  let b = matrix[mid][1];
  let c = matrix[mid][2];

  let win=false;
  let winAmount=0;
  let viaJoker=false;
  let winSymbol=null;

  if (c === JOKER_SYMBOL) {
    win = true;
    viaJoker = true;
    winSymbol = JOKER_SYMBOL;
    a = JOKER_SYMBOL;
    b = JOKER_SYMBOL;
    matrix[mid][0] = JOKER_SYMBOL;
    matrix[mid][1] = JOKER_SYMBOL;
  } else if (a === b && b === c && PAYOUTS[a]) {
    win = true;
    winSymbol = a;
  }

  setGrid(matrix);

  if(win){
    winAmount = PAYOUTS[winSymbol] * bet;
    setBalance(getBalance() + winAmount);

    if(viaJoker){
      resultText.textContent = `ü§° JOKER! –ü–µ—á–µ–ª–∏—à ${winAmount} –º–æ–Ω–µ—Ç–∏ (x${PAYOUTS[winSymbol]})!`;
    } else if(winSymbol==="7Ô∏è‚É£"){
      resultText.textContent = `üíé –î–ñ–ê–ö–ü–û–¢! –ü–µ—á–µ–ª–∏—à ${winAmount} –º–æ–Ω–µ—Ç–∏ (x${PAYOUTS[winSymbol]})!`;
    } else {
      resultText.textContent = `üéâ –ü–µ—á–µ–ª–∏—à ${winAmount} –º–æ–Ω–µ—Ç–∏ (x${PAYOUTS[winSymbol]})!`;
    }

    const middleCells = document.querySelectorAll('.cell[data-row="1"]');
    middleCells.forEach(cel=>{
      cel.classList.add("win");
      if(winSymbol==="7Ô∏è‚É£") cel.classList.add("seven-win");
      if(viaJoker) cel.classList.add("joker-win");
    });

    play(audioWin);
  } else {
    resultText.textContent="‚ùå –ù—è–º–∞ –ø–µ—á–∞–ª–±–∞. –û–ø–∏—Ç–∞–π –ø–∞–∫!";
    play(audioLose);
  }

  // –º–æ–º–µ–Ω—Ç–µ–Ω –ø–æ—Ä—Ç—Ñ–µ–π–ª ‚Äì —Å–∞–º–æ –≤ REAL —Ä–µ–∂–∏–º
  autoBankToWallet();

  const dt = getDateTime();
  const comboText = `${a} ${b} ${c}`;
  if (win) {
    const cls = viaJoker ? "history-box history-joker" : "history-box history-win";
    historyEl.innerHTML =
      `<div class="${cls}">[${dt}] –†–µ–∂–∏–º: ${currentMode} | –ó–∞–ª–æ–≥: ${bet} | –ü–µ—á–∞–ª–±–∞: ${winAmount} | –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${comboText}</div>`;
  } else {
    historyEl.innerHTML =
      `<div class="history-box history-lose">[${dt}] –†–µ–∂–∏–º: ${currentMode} | –ó–∞–ª–æ–≥: ${bet} | –ë–µ–∑ –ø–µ—á–∞–ª–±–∞</div>`;
  }

  spinning=false;
  spinBtn.textContent="SPIN";
  updateUI();

  if (win && viaJoker) {
    boosterMode = false;
    showBonus(bet);
    return;
  }

  if (boosterMode && !bonusActive) {
    setTimeout(()=>{
      if (boosterMode && !spinning && !bonusActive) {
        startSpin();
      }
    }, 200);
  }
}

// –±–æ–Ω—É—Å –∏–∑–±–æ—Ä
bonusButtons.forEach(btn=>{
  btn.addEventListener("click",()=>{
    if(!bonusActive) return;
    const mult = parseInt(btn.dataset.mult,10);
    const bonusWin = bonusBaseBet * mult;
    setBalance(getBalance() + bonusWin);
    play(audioWin);
    resultText.textContent = `üéÅ –ë–æ–Ω—É—Å –ø–µ—á–∞–ª–±–∞: ${bonusWin} –º–æ–Ω–µ—Ç–∏ (x${mult} –æ—Ç –∑–∞–ª–æ–≥–∞)!`;
    const dt = getDateTime();
    historyEl.innerHTML =
      `<div class="history-box history-joker">[${dt}] –ë–û–ù–£–° | –ú–Ω–æ–∂–∏—Ç–µ–ª: x${mult} | –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –ø–µ—á–∞–ª–±–∞: ${bonusWin}</div>`;
    autoBankToWallet();
    hideBonus();
  });
});

// –∑–∞–ª–æ–≥
betMinusBtn.onclick=()=>{ if(!spinning && !bonusActive && bet>1){ bet--; updateUI(); } }
betPlusBtn.onclick=()=>{ if(!spinning && !bonusActive && bet<50){ bet++; updateUI(); } }

// BOOSTER ‚Äì –∑–∞–¥—ä—Ä–∂–∞–Ω–µ
function handlePointerDown(e){
  e.preventDefault();
  if (spinBtn.disabled || bonusActive) return;
  isHoldCandidate = true;

  holdTimeoutId = setTimeout(()=>{
    if (isHoldCandidate && !boosterMode) {
      boosterMode = true;
      resultText.textContent = "üöÄ BOOSTER —Ä–µ–∂–∏–º: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ –∑–∞–≤—ä—Ä—Ç–∞–Ω–∏—è ‚Äì –ø—É—Å–Ω–∏ –±—É—Ç–æ–Ω–∞, –∑–∞ –¥–∞ —Å–ø—Ä–µ—à.";
      if (!spinning) {
        startSpin();
      }
    }
  }, 400);
}

function handlePointerUp(e){
  e.preventDefault();
  if (holdTimeoutId) {
    clearTimeout(holdTimeoutId);
    holdTimeoutId = null;
  }

  if (boosterMode) {
    boosterMode = false;
    isHoldCandidate = false;
    resultText.textContent = "BOOSTER —Ä–µ–∂–∏–º –∏–∑–∫–ª—é—á–µ–Ω. –í–∏–µ —Å—Ç–µ –≤ –Ω–æ—Ä–º–∞–ª–µ–Ω —Ä–µ–∂–∏–º.";
    return;
  }

  if (isHoldCandidate && !bonusActive) {
    isHoldCandidate = false;
    if (spinning) {
      stopSpin();
    } else {
      startSpin();
    }
  }
}

spinBtn.addEventListener("mousedown", handlePointerDown);
spinBtn.addEventListener("mouseup", handlePointerUp);
spinBtn.addEventListener("mouseleave", handlePointerUp);
spinBtn.addEventListener("touchstart", handlePointerDown, {passive:false});
spinBtn.addEventListener("touchend", handlePointerUp, {passive:false});
spinBtn.addEventListener("touchcancel", handlePointerUp, {passive:false});

// ‚Äû–∏–∑–ø–ª–∞—â–∞–Ω–µ‚Äú (—Å–∏–º—É–ª–∞—Ü–∏—è, –Ω–µ –ø—Ä–æ–º–µ–Ω—è –ø–æ—Ä—Ç—Ñ–µ–π–ª–∞)
walletCashoutBtn.onclick = ()=>{
  if(!currentUser){
    resultText.textContent = "–ó–∞ –ø–æ—Ä—Ç—Ñ–µ–π–ª —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–ª–µ–∑–µ—à —Å Gmail (–†–ï–ê–õ–ù–ò –°–†–ï–î–°–¢–í–ê).";
    return;
  }
  if(walletBgn <= 0){
    resultText.textContent = "–ù—è–º–∞—à –Ω–∞—Ç—Ä—É–ø–∞–Ω–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ –ø–æ—Ä—Ç—Ñ–µ–π–ª–∞.";
    return;
  }
  const msg = `üí∞ –°–∏–º—É–ª–∞—Ü–∏—è: –ø–æ—Ä—Ç—Ñ–µ–π–ª—ä—Ç —Ç–∏ –∏–º–∞ ${walletBgn.toFixed(2)} BGN (~${(walletBgn*BGN_TO_EUR).toFixed(2)} EUR).`;
  resultText.textContent = msg;
  const dt = getDateTime();
  historyEl.innerHTML =
    `<div class="history-box history-win">[${dt}] –ü–û–†–¢–§–ï–ô–õ | ${msg}</div>`;
};

// –Ω–∞—á–∞–ª–Ω–∞ –ø–æ–¥—Ä–µ–¥–±–∞
setGrid([
  ["üîî","üçí","üçá"],
  ["üçë","üçê","üçá"],
  ["üçí","üçá","üîî"],
]);

// GOOGLE LOGIN
function parseJwt(token){
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c){
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

function handleCredentialResponse(response){
  try {
    const data = parseJwt(response.credential);
    currentUser = {
      email: data.email,
      name: data.name || data.given_name || data.email,
      picture: data.picture || null
    };
    loadRealBalanceForUser(currentUser.email);
    // –ø–æ—Ä—Ç—Ñ–µ–π–ª—ä—Ç –æ—Å—Ç–∞–≤–∞ –º–æ–º–µ–Ω—Ç–µ–Ω ‚Äì –Ω–µ –∑–∞—Ä–µ–∂–¥–∞–º–µ –Ω–∏—â–æ –æ—Ç –±–∞–∑–∞
    authInfo.textContent = `–í–ª—è–∑—ä–ª –∫–∞—Ç–æ: ${currentUser.name} (${currentUser.email})`;
    realModeBtn.disabled = false;
    switchMode("REAL");
  } catch(e){
    console.error(e);
    authInfo.textContent = "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–∞ —Å Google.";
  }
}

window.onload = function() {
  loadDemoBalance();
  updateUI();

  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({
      client_id: "114661235982-8kips5s57fk0rn2e9bf8it8chd7shhsr.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("googleSignIn"),
      { theme: "outline", size: "medium", type: "standard" }
    );
  }
};

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(()=>{});
}
</script>

</body>
</html>
