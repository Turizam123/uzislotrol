<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>üé∞ SPIN –†–æ–ª–µ—Ç–∫–∞ —Å JOKER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA (–ø–æ –∂–µ–ª–∞–Ω–∏–µ ‚Äì –∞–∫–æ –∏–º–∞—à manifest.json –∏ sw.js) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="icon" href="icon-192.png">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #444, #111 55%);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .game-wrapper { max-width: 500px; width: 100%; padding: 20px; }
    .card {
      background: rgba(0,0,0,0.85);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
      border: 1px solid rgba(255,255,255,0.06);
    }
    h1 { text-align:center; margin:0 0 8px; }
    .subtitle {
      text-align:center;
      font-size:0.9rem;
      opacity:0.9;
      margin-bottom:6px;
    }
    .subtitle small { font-size:0.8rem; opacity:0.8; display:block; }

    .status-bar { display:flex; justify-content:space-between; margin:10px 0; font-size:0.95rem; }
    .highlight { color:#ffd86b; }

    .slot-frame { margin-top:12px; }
    .slot-window {
      padding:10px;
      background:#222;
      border-radius:14px;
      box-shadow:inset 0 0 12px #000;
      position:relative;
    }
    .slot-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      grid-template-rows:repeat(3,80px);
      gap:8px;
    }
    .cell {
      background:#111;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:2.4rem;
      box-shadow:inset 0 0 8px #000;
      transition:transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }
    .middle-row {
      box-shadow:0 0 0 1px rgba(255,215,0,0.7), 0 0 12px rgba(255,215,0,0.4);
    }
    .win {
      background: radial-gradient(circle at 30% 20%, #fff4c2, #e0a900 55%);
      color:#000;
      box-shadow:0 0 0 2px rgba(0,0,0,0.7),0 0 20px rgba(255,230,150,0.8);
    }
    .seven-win {
      animation:seven 0.3s infinite alternate;
      box-shadow:0 0 20px red, 0 0 30px gold;
    }
    .joker-win {
      animation:jokerPulse 0.35s infinite alternate;
      box-shadow:0 0 20px rgba(155,89,182,0.9), 0 0 30px rgba(52,152,219,0.9);
    }
    @keyframes seven {
      from { transform:scale(1); }
      to   { transform:scale(1.12); }
    }
    @keyframes jokerPulse {
      from { transform:scale(1); }
      to   { transform:scale(1.1) rotate(1deg); }
    }

    @keyframes reel-spin {
      0% { transform:translateY(0); }
      50% { transform:translateY(4px); }
      100% { transform:translateY(0); }
    }
    .spinning .cell { animation:reel-spin 0.18s infinite; }

    .controls {
      display:flex;
      justify-content:space-between;
      margin-top:15px;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .spin-btn {
      flex:1;
      padding:12px;
      background:radial-gradient(circle at 20% 20%, #ffec9b,#f4ba00 55%,#a86800);
      border:none;
      border-radius:999px;
      font-size:1.1rem;
      font-weight:bold;
      color:#351f00;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,0.8);
    }
    .spin-btn:active {
      transform:translateY(1px) scale(0.99);
      box-shadow:0 4px 16px rgba(0,0,0,0.9);
    }
    .spin-btn:disabled { opacity:0.6; cursor:not-allowed; }

    .bet-box { display:flex; gap:8px; align-items:center; }
    .icon-btn {
      width:30px; height:30px;
      border-radius:999px;
      border:none;
      background:rgba(255,255,255,0.08);
      color:#fff;
      cursor:pointer;
      font-size:1.1rem;
    }
    #resultText {
      text-align:center;
      margin-top:12px;
      min-height:22px;
      font-size:0.95rem;
    }

    /* –ë–∞–ª–æ–Ω—á–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—è —Ä–µ–∑—É–ª—Ç–∞—Ç */
    #history {
      margin-top: 10px;
      text-align: center;
      min-height: 30px;
    }

    .history-box {
      display: inline-block;
      position: relative;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid transparent;
      font-size: 0.85rem;
      max-width: 100%;
      white-space: normal;
    }

    .history-box::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid transparent;
    }

    .history-win {
      border-color: rgba(46, 204, 113, 0.9);
      color: #c9ffd8;
      box-shadow: 0 0 10px rgba(46, 204, 113, 0.7), 0 0 20px rgba(39, 174, 96, 0.9);
      animation: historyPulseGreen 0.5s ease-in-out 0s 4 alternate;
    }
    .history-win::after {
      border-top-color: rgba(46, 204, 113, 0.9);
    }

    .history-lose {
      border-color: rgba(231, 76, 60, 0.9);
      color: #ffd1d1;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.7), 0 0 20px rgba(192, 57, 43, 0.9);
      animation: historyPulseRed 0.5s ease-in-out 0s 3 alternate;
    }
    .history-lose::after {
      border-top-color: rgba(231, 76, 60, 0.9);
    }

    .history-joker {
      border-color: rgba(155, 89, 182, 0.95);
      color: #f8e9ff;
      box-shadow: 0 0 10px rgba(155,89,182,0.8), 0 0 24px rgba(52,152,219,0.9);
      animation: historyPulseJoker 0.55s ease-in-out 0s 5 alternate;
    }
    .history-joker::after {
      border-top-color: rgba(155, 89, 182, 0.95);
    }

    @keyframes historyPulseGreen {
      from { transform: translateY(0) scale(1); }
      to   { transform: translateY(-2px) scale(1.05); }
    }
    @keyframes historyPulseRed {
      from { transform: translateY(0) scale(1); }
      to   { transform: translateY(-2px) scale(1.05); }
    }
    @keyframes historyPulseJoker {
      from { transform: translateY(0) scale(1) rotate(-1deg); }
      to   { transform: translateY(-2px) scale(1.06) rotate(1deg); }
    }

    @media (max-width:480px){
      .slot-grid{ grid-template-rows:repeat(3,68px); }
      .cell{ font-size:2rem; }
    }
  </style>
</head>
<body>

<div class="game-wrapper">
  <div class="card">

    <h1>üé∞ SPIN –†–æ–ª–µ—Ç–∫–∞</h1>
    <p class="subtitle">
      –ü–µ—á–µ–ª–∏ —Å–∞–º–æ <span class="highlight">—Å—Ä–µ–¥–Ω–∏—è—Ç —Ä–µ–¥</span> (–µ–¥–Ω–∞ –ª–∏–Ω–∏—è).<br>
      <small>üÉè JOKER –Ω–∞ —Ç—Ä–µ—Ç–∏ –±–∞—Ä–∞–±–∞–Ω –ø—Ä–∞–≤–∏ —Ä–µ–¥–∞ üÉèüÉèüÉè –∏ –ø–ª–∞—â–∞ –º–Ω–æ–∂–∏—Ç–µ–ª –≤—ä—Ä—Ö—É –∑–∞–ª–æ–≥–∞ (~20% RTP –æ–±—â–æ).</small>
    </p>

    <div class="status-bar">
      <div>–ë–∞–ª–∞–Ω—Å: <span id="balance" class="highlight">100</span> ü™ô</div>
      <div>–†–µ–∂–∏–º: <span id="modeLabel">–ù–æ—Ä–º–∞–ª–µ–Ω</span></div>
    </div>

    <div class="slot-frame">
      <div class="slot-window" id="slotWindow">
        <div class="slot-grid" id="slotGrid">
          <div class="cell" data-row="0" data-col="0">‚ùì</div>
          <div class="cell" data-row="0" data-col="1">‚ùì</div>
          <div class="cell" data-row="0" data-col="2">‚ùì</div>

          <div class="cell middle-row" data-row="1" data-col="0">‚ùì</div>
          <div class="cell middle-row" data-row="1" data-col="1">‚ùì</div>
          <div class="cell middle-row" data-row="1" data-col="2">‚ùì</div>

          <div class="cell" data-row="2" data-col="0">‚ùì</div>
          <div class="cell" data-row="2" data-col="1">‚ùì</div>
          <div class="cell" data-row="2" data-col="2">‚ùì</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="bet-box">
        <button class="icon-btn" id="betMinus">‚àí</button>
        <span id="betValue">5</span>
        <button class="icon-btn" id="betPlus">+</button>
      </div>

      <button id="spinBtn" class="spin-btn">SPIN</button>
    </div>

    <div id="resultText">–ü–µ—á–∞–ª–±–∞ –ø—Ä–∏ 3 –µ–¥–Ω–∞–∫–≤–∏ —Å–∏–º–≤–æ–ª–∞ –ø–æ —Å—Ä–µ–¥–Ω–∏—è —Ä–µ–¥.</div>

    <!-- –ë–∞–ª–æ–Ω—á–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—è —Ä–µ–∑—É–ª—Ç–∞—Ç -->
    <div id="history"></div>

  </div>
</div>

<!-- –ê—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤–µ (.wav) -->
<audio id="audioSpin" src="spin_effect.wav" preload="auto"></audio>
<audio id="audioSpinMusic" src="spin_music.wav" preload="auto"></audio>
<audio id="audioWin" src="win.wav" preload="auto"></audio>
<audio id="audioLose" src="lose.wav" preload="auto"></audio>
<audio id="bgMusic" src="music.wav" preload="auto" loop></audio>

<script>
const JOKER_SYMBOL = "üÉè";

// —à–∞–Ω—Å –∑–∞ —Å–∏–º–≤–æ–ª–∏—Ç–µ ‚Äì –∫–∞—Ç–æ –≤ —Å–ª–æ—Ç —Ç–∞–±–ª–∏—Ü–∞
const SYMBOLS = [
  {emoji:"7Ô∏è‚É£",weightNormal:1,weightEasy:2},
  {emoji:"üîî",weightNormal:2,weightEasy:3},
  {emoji:"üçí",weightNormal:3,weightEasy:4},
  {emoji:"üçë",weightNormal:4,weightEasy:5},
  {emoji:"üçê",weightNormal:5,weightEasy:6},
  {emoji:"üçá",weightNormal:6,weightEasy:7},
  {emoji:JOKER_SYMBOL,weightNormal:1,weightEasy:2} // JOKER (—Å–∞–º–æ –Ω–∞ 3-—Ç–∏ –±–∞—Ä–∞–±–∞–Ω)
];

// –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ –∑–∞–ª–æ–≥–∞ (–Ω–∞—Å—Ç—Ä–æ–π–≤–∞–Ω–∏ —Ç–∞–∫–∞, —á–µ RTP ~= 20%)
const PAYOUTS = {
  "7Ô∏è‚É£":15, // 15x –∑–∞–ª–æ–≥–∞
  "üîî":6,
  "üçí":4,
  "üçë":2,
  "üçê":1,
  "üçá":1,
  "üÉè":3  // JOKER ‚Äì 3x –∑–∞–ª–æ–≥–∞
};

let balance=100, bet=5;
let spinning=false, easyMode=false;
let spinInterval=null, stopRequested=false, autoStopTimeout=null;
let bgMusicStarted=false;

/* DOM */
const balanceEl=document.getElementById("balance");
const betValueEl=document.getElementById("betValue");
const spinBtn=document.getElementById("spinBtn");
const betMinusBtn=document.getElementById("betMinus");
const betPlusBtn=document.getElementById("betPlus");
const resultText=document.getElementById("resultText");
const slotWindow=document.getElementById("slotWindow");
const modeLabel=document.getElementById("modeLabel");
const historyEl=document.getElementById("history");

/* Audio */
const audioSpin=document.getElementById("audioSpin");
const audioSpinMusic=document.getElementById("audioSpinMusic");
const audioWin=document.getElementById("audioWin");
const audioLose=document.getElementById("audioLose");
const bgMusic=document.getElementById("bgMusic");

function getDateTime() {
  const d = new Date();
  const pad = n => n.toString().padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ` +
         `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function updateUI(){
  balanceEl.textContent=balance;
  betValueEl.textContent=bet;
  modeLabel.textContent = easyMode ? "–ü–æ-–ª–µ—Å–µ–Ω" : "–ù–æ—Ä–º–∞–ª–µ–Ω";
}

function play(audio){
  if(!audio) return;
  try { audio.currentTime=0; audio.play(); } catch(e){}
}

function buildPool(includeJoker){
  const pool=[];
  SYMBOLS.forEach(s=>{
    if(!includeJoker && s.emoji===JOKER_SYMBOL) return;
    const w = easyMode ? s.weightEasy : s.weightNormal;
    for(let i=0;i<w;i++) pool.push(s.emoji);
  });
  return pool;
}

function setGrid(matrix){
  document.querySelectorAll(".cell").forEach(c=>{
    let r=c.dataset.row, col=c.dataset.col;
    c.textContent=matrix[r][col];
  });
}

function clearWin(){
  document.querySelectorAll(".cell").forEach(c=>{
    c.classList.remove("win","seven-win","joker-win");
  });
}

function startSpin(){
  if(spinning) return;
  if(bet>balance){
    resultText.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–µ–Ω –±–∞–ª–∞–Ω—Å.";
    return;
  }

  spinning=true;
  stopRequested=false;
  spinBtn.textContent="STOP";

  historyEl.innerHTML = "";
  historyEl.className = "";

  clearWin();

  balance-=bet; updateUI();

  if(!bgMusicStarted){ play(bgMusic); bgMusicStarted=true; }

  play(audioSpin);
  play(audioSpinMusic);

  const poolAll = buildPool(true);      // —Å JOKER
  const poolNoJoker = buildPool(false); // –±–µ–∑ JOKER

  let matrix=[["","",""],["","",""],["","",""]];

  slotWindow.classList.add("spinning");

  spinInterval=setInterval(()=>{
    for(let c=0;c<3;c++){
      const pool = (c === 2) ? poolAll : poolNoJoker; // JOKER —Å–∞–º–æ –Ω–∞ 3-—Ç–∏ –±–∞—Ä–∞–±–∞–Ω
      for(let r=0;r<3;r++){
        matrix[r][c]= pool[Math.floor(Math.random()*pool.length)];
      }
    }
    setGrid(matrix);
    if(stopRequested){
      clearInterval(spinInterval);
      finalize(matrix);
    }
  },90);

  autoStopTimeout=setTimeout(()=>{stopRequested=true;},1600);
}

function stopSpin(){ stopRequested=true; }

function finalize(matrix){
  clearInterval(spinInterval);
  slotWindow.classList.remove("spinning");
  if(autoStopTimeout) clearTimeout(autoStopTimeout);

  try{ audioSpinMusic.pause(); audioSpinMusic.currentTime=0; }catch(e){}

  const mid = 1; // —Å–∞–º–æ —Å—Ä–µ–¥–µ–Ω —Ä–µ–¥ –ø–µ—á–µ–ª–∏
  let a = matrix[mid][0];
  let b = matrix[mid][1];
  let c = matrix[mid][2];

  let win=false;
  let winAmount=0;
  let viaJoker=false;
  let winSymbol=null;

  // JOKER –Ω–∞ —Ç—Ä–µ—Ç–∏ –±–∞—Ä–∞–±–∞–Ω -> –º–∞–≥–∏—á–µ—Å–∫–∏ —Ä–µ–¥ üÉèüÉèüÉè
  if (c === JOKER_SYMBOL) {
    win = true;
    viaJoker = true;
    winSymbol = JOKER_SYMBOL;

    a = JOKER_SYMBOL;
    b = JOKER_SYMBOL;
    matrix[mid][0] = JOKER_SYMBOL;
    matrix[mid][1] = JOKER_SYMBOL;
    // c –≤–µ—á–µ –µ JOKER
  }
  // –∏–Ω–∞—á–µ –∫–ª–∞—Å–∏—á–µ—Å–∫–∏ 3 –µ–¥–Ω–∞–∫–≤–∏ —Å–∏–º–≤–æ–ª–∞
  else if (a === b && b === c && PAYOUTS[a]) {
    win = true;
    winSymbol = a;
  }

  // —ä–ø–¥–µ–π—Ç–≤–∞–º–µ –≥—Ä–∏–¥ (–∑–∞ –¥–∞ —Å–µ –≤–∏–¥—è—Ç –µ–≤–µ–Ω—Ç—É–∞–ª–Ω–∏ –¥–∂–æ–∫–µ—Ä–∏)
  setGrid(matrix);

  if(win){
    winAmount = PAYOUTS[winSymbol] * bet; // –º–Ω–æ–∂–∏—Ç–µ–ª * –∑–∞–ª–æ–≥
    balance += winAmount;

    if(viaJoker){
      resultText.textContent = `ü§° JOKER! –ü–µ—á–µ–ª–∏—à ${winAmount} –º–æ–Ω–µ—Ç–∏ (x${PAYOUTS[winSymbol]})!`;
    } else if(winSymbol==="7Ô∏è‚É£"){
      resultText.textContent = `üíé –î–ñ–ê–ö–ü–û–¢! –ü–µ—á–µ–ª–∏—à ${winAmount} –º–æ–Ω–µ—Ç–∏ (x${PAYOUTS[winSymbol]})!`;
    } else {
      resultText.textContent = `üéâ –ü–µ—á–µ–ª–∏—à ${winAmount} –º–æ–Ω–µ—Ç–∏ (x${PAYOUTS[winSymbol]})!`;
    }

    const middleCells = document.querySelectorAll('.cell[data-row="1"]');
    middleCells.forEach(cel=>{
      cel.classList.add("win");
      if(winSymbol==="7Ô∏è‚É£") cel.classList.add("seven-win");
      if(viaJoker) cel.classList.add("joker-win");
    });

    play(audioWin);
  } else {
    resultText.textContent="‚ùå –ù—è–º–∞ –ø–µ—á–∞–ª–±–∞. –û–ø–∏—Ç–∞–π –ø–∞–∫!";
    play(audioLose);
  }

  // –ë–∞–ª–æ–Ω—á–µ –∏—Å—Ç–æ—Ä–∏—è
  const dt = getDateTime();
  const comboText = `${a} ${b} ${c}`;
  if (win) {
    const cls = viaJoker ? "history-box history-joker" : "history-box history-win";
    historyEl.innerHTML =
      `<div class="${cls}">[${dt}] –ó–∞–ª–æ–≥: ${bet} | –ü–µ—á–∞–ª–±–∞: ${winAmount} | –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${comboText}</div>`;
  } else {
    historyEl.innerHTML =
      `<div class="history-box history-lose">[${dt}] –ó–∞–ª–æ–≥: ${bet} | –ë–µ–∑ –ø–µ—á–∞–ª–±–∞</div>`;
  }

  spinning=false;
  spinBtn.textContent="SPIN";
  updateUI();
}

spinBtn.onclick=()=> spinning ? stopSpin() : startSpin();
betMinusBtn.onclick=()=>{ if(!spinning && bet>1){ bet--; updateUI(); } }
betPlusBtn.onclick=()=>{ if(!spinning && bet<50){ bet++; updateUI(); } }

// –Ω–∞—á–∞–ª–Ω–∞ –ø–æ–¥—Ä–µ–¥–±–∞
setGrid([
  ["üîî","üçí","üçá"],
  ["üçë","üçê","üçá"],
  ["üçí","üçá","üîî"],
]);
updateUI();

// PWA service worker (–ø–æ –∂–µ–ª–∞–Ω–∏–µ, –∞–∫–æ –∏–º–∞—à sw.js)
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(()=>{});
}
</script>

</body>
</html>
